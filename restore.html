<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wordrobe Data Restore V2</title>
    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #F8FAFC; color: #333; }
        h1 { color: #258FAF; font-size: 1.5rem; text-align: center; }
        .box { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin: 0 auto; max-width: 400px; text-align: center; }
        button { background: #258FAF; color: white; border: none; padding: 15px; font-size: 1rem; font-weight: bold; border-radius: 10px; width: 100%; margin-top: 10px; cursor: pointer; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        #logs { margin-top: 20px; background: #1e293b; color: #4ade80; padding: 10px; border-radius: 8px; font-family: monospace; font-size: 0.8rem; text-align: left; min-height: 100px; max-height: 200px; overflow-y: auto; white-space: pre-wrap; }
        .error-log { color: #ef4444; }
    </style>
</head>
<body>

    <div class="box">
        <h1>ğŸ› ï¸ ãƒ‡ãƒ¼ã‚¿å¼·åˆ¶å¾©æ—§ V2</h1>
        <p style="font-size:0.9rem; color:#666;">ã‚¯ãƒ©ã‚¦ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™ã€‚</p>
        
        <div id="user-display" style="font-weight:bold; margin:10px 0; min-height:20px;">æœªãƒ­ã‚°ã‚¤ãƒ³</div>
        
        <button id="actionBtn" onclick="handleAction()">åˆæœŸåŒ–ä¸­...</button>
        
        <div id="logs">ãƒ­ã‚°å¾…æ©Ÿä¸­...</div>
    </div>

    <script>
        // ãƒ­ã‚°è¡¨ç¤ºç”¨é–¢æ•°
        const logEl = document.getElementById('logs');
        function log(msg, isError = false) {
            const line = document.createElement('div');
            line.textContent = `> ${msg}`;
            if(isError) line.className = 'error-log';
            logEl.appendChild(line);
            logEl.scrollTop = logEl.scrollHeight;
            console.log(msg);
        }

        // 1. Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyCqoqNq7N-x5Wr6TsJkyCU0J6o-Mj1Ir8g",
            authDomain: "conizm-01.firebaseapp.com",
            projectId: "conizm-01",
            storageBucket: "conizm-01.firebasestorage.app",
            messagingSenderId: "180210157068",
            appId: "1:180210157068:web:e03a373dd3f818cdee1029",
            measurementId: "G-YD40SF3F32"
        };
        
        try {
            firebase.initializeApp(firebaseConfig);
            log("Firebase Initialized");
        } catch(e) { log("Init Error: " + e.message, true); }

        const db_firebase = firebase.firestore();
        const auth = firebase.auth();
        const db = new Dexie('WordloopDB');
        db.version(3).stores({ words: '++id, word, nextReview, interval, repetition, efactor, addedAt, folder', deleted_words: 'word' });

        const btn = document.getElementById('actionBtn');
        const userDisplay = document.getElementById('user-display');
        let currentUser = null;

        // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ç®¡ç†
        function setButtonState(state) {
            if (state === 'login') {
                btn.innerText = "Googleã§ãƒ­ã‚°ã‚¤ãƒ³";
                btn.onclick = login;
                btn.disabled = false;
            } else if (state === 'restore') {
                btn.innerText = "ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒå®Ÿè¡Œ";
                btn.onclick = restoreData;
                btn.disabled = false;
            } else if (state === 'loading') {
                btn.disabled = true;
                btn.innerText = "å‡¦ç†ä¸­...";
            }
        }

        // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ï¼ˆæ˜ç¤ºçš„ã«Persistenceã‚’è¨­å®šï¼‰
        function login() {
            setButtonState('loading');
            log("ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†é–‹å§‹...");
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰ã«ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ä¿å­˜ã™ã‚‹è¨­å®š
            auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                .then(() => {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    return auth.signInWithRedirect(provider);
                })
                .catch((error) => {
                    log("Login Error: " + error.message, true);
                    setButtonState('login');
                });
        }

        // å¾©å…ƒå‡¦ç†
        async function restoreData() {
            if (!currentUser) return log("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“", true);
            setButtonState('loading');
            log("ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹...");

            try {
                const doc = await db_firebase.collection('users').doc(currentUser.uid).get();
                
                if (!doc.exists) {
                    log("âŒ ã‚¯ãƒ©ã‚¦ãƒ‰ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼", true);
                    alert("ã‚¯ãƒ©ã‚¦ãƒ‰ã«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\nPCã§ãƒ‡ãƒ¼ã‚¿é€ä¿¡ãŒå®Œäº†ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                    setButtonState('restore');
                    return;
                }

                const cloudWords = doc.data().words || [];
                log(`ğŸ“¦ ${cloudWords.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—`);

                await db.words.clear();
                await db.words.bulkAdd(cloudWords);
                
                log("âœ… DBæ›¸ãè¾¼ã¿å®Œäº†");
                alert("å¾©å…ƒæˆåŠŸï¼\nã“ã‚Œã§ç›´ã‚Šã¾ã—ãŸã€‚wordrobe.htmlã«æˆ»ã£ã¦ãã ã•ã„ã€‚");
                
            } catch (e) {
                log("Restore Error: " + e.message, true);
                setButtonState('restore');
            }
        }

        // èµ·å‹•æ™‚ã®ãƒã‚§ãƒƒã‚¯ï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆçµæœã®å–å¾—ã‚’å„ªå…ˆï¼‰
        log("èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèªä¸­...");
        
        auth.getRedirectResult().then((result) => {
            if (result.user) {
                log("RedirectæˆåŠŸ: " + result.user.email);
            }
        }).catch((error) => {
            log("Redirect Error: " + error.message, true);
        });

        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                userDisplay.innerText = "ãƒ­ã‚°ã‚¤ãƒ³ä¸­: " + user.email;
                userDisplay.style.color = "#258FAF";
                log("User Found: " + user.uid);
                setButtonState('restore');
            } else {
                currentUser = null;
                userDisplay.innerText = "æœªãƒ­ã‚°ã‚¤ãƒ³";
                userDisplay.style.color = "#666";
                log("User Not Found (Guest)");
                setButtonState('login');
            }
        });

    </script>
</body>
</html>
