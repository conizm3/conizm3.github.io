<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Wordrobe Fixer</title>
    
    <!-- PWAè¨­å®š -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="WR Fixer">
    <link rel="apple-touch-icon" href="https://conizm3.github.io/wordrobe/images/wordrobe-icon.png">
    
    <!-- å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body { font-family: sans-serif; background-color: #F8FAFC; color: #333; touch-action: manipulation; }
        .neu-flat { background: #F8FAFC; box-shadow: 5px 5px 10px #E6EFF5, -5px -5px 10px #FFFFFF; border-radius: 20px; }
        .neu-btn { background: #F8FAFC; box-shadow: 3px 3px 6px #E6EFF5, -3px -3px 6px #FFFFFF; border-radius: 12px; transition: 0.1s; }
        .neu-btn:active { box-shadow: inset 2px 2px 4px #E6EFF5, inset -2px -2px 4px #FFFFFF; transform: scale(0.98); }
        .log-area { background: #1e293b; color: #4ade80; font-family: monospace; font-size: 10px; padding: 10px; border-radius: 8px; height: 120px; overflow-y: auto; text-align: left; }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center p-6">

    <div class="neu-flat p-6 w-full max-w-sm text-center relative">
        <div class="absolute top-0 left-0 w-full h-1 bg-[#258FAF] rounded-t-2xl"></div>
        
        <h1 class="text-xl font-bold text-[#258FAF] mb-2 flex items-center justify-center gap-2">
            <i class="fas fa-tools"></i> ä¿®å¾©ï¼†èµ·å‹•ãƒ„ãƒ¼ãƒ«
        </h1>
        <p class="text-xs text-gray-400 mb-6">
            é€šä¿¡ã‚¨ãƒ©ãƒ¼ã‚’ç›´ã—ã€ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¦<br>ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¾ã™ã€‚
        </p>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
        <div id="status" class="text-sm font-bold text-gray-600 mb-4 h-6">æœªãƒ­ã‚°ã‚¤ãƒ³</div>

        <!-- ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
        <div class="space-y-3">
            <button id="loginBtn" onclick="startLogin()" class="neu-btn w-full py-4 text-[#258FAF] font-bold flex items-center justify-center gap-2">
                <i class="fab fa-google"></i> ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦å¾©æ—§
            </button>

            <!-- å¾©æ—§å¾Œã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒœã‚¿ãƒ³ -->
            <button id="goAppBtn" onclick="goToApp()" class="w-full py-4 bg-[#258FAF] text-white rounded-xl font-bold shadow-lg hidden flex items-center justify-center gap-2 animate-pulse">
                <i class="fas fa-play"></i> ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã™ã‚‹
            </button>
        </div>

        <!-- ãƒ­ã‚°ã‚¨ãƒªã‚¢ -->
        <div class="mt-6">
            <div id="logs" class="log-area">ã‚·ã‚¹ãƒ†ãƒ å¾…æ©Ÿä¸­...</div>
        </div>
    </div>

    <script>
        const logEl = document.getElementById('logs');
        function log(msg) {
            logEl.innerHTML += `\n> ${msg}`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        // èµ·å‹•æ™‚ã«ã‚¾ãƒ³ãƒ“SWã‚’å³æ­»ã•ã›ã‚‹ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ç‰ˆï¼‰
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.getRegistrations()
                    .then(function(registrations) {
                        if (registrations.length > 0) {
                            log("âš ï¸ å¤ã„é€šä¿¡è¨­å®šã‚’ç™ºè¦‹");
                            for(let registration of registrations) {
                                registration.unregister().then(() => log("ğŸ”¥ å‰Šé™¤ã—ã¾ã—ãŸ"));
                            }
                        } else {
                            log("âœ… é€šä¿¡ç’°å¢ƒã¯ã‚¯ãƒªãƒ¼ãƒ³ã§ã™");
                        }
                    })
                    .catch(function(error) {
                        console.warn("Service Worker check skipped:", error);
                        // ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã‚‚å‹•ä½œã«æ”¯éšœã¯ãªã„ã®ã§ãƒ­ã‚°ã ã‘å‡ºã™
                        log("â„¹ï¸ SWãƒã‚§ãƒƒã‚¯: ã‚¹ã‚­ãƒƒãƒ— (" + error.name + ")");
                    });
            });
        }

        const firebaseConfig = {
            apiKey: "AIzaSyCqoqNq7N-x5Wr6TsJkyCU0J6o-Mj1Ir8g",
            authDomain: "conizm-01.firebaseapp.com",
            projectId: "conizm-01",
            storageBucket: "conizm-01.firebasestorage.app",
            messagingSenderId: "180210157068",
            appId: "1:180210157068:web:e03a373dd3f818cdee1029",
            measurementId: "G-YD40SF3F32"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db_firebase = firebase.firestore();
        const auth = firebase.auth();
        const db = new Dexie('WordloopDB');
        db.version(3).stores({ words: '++id, word, nextReview, interval, repetition, efactor, addedAt, folder', deleted_words: 'word' });

        const loginBtn = document.getElementById('loginBtn');
        const goAppBtn = document.getElementById('goAppBtn');
        const statusEl = document.getElementById('status');
        let currentUser = null;

        // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼‰
        function startLogin() {
            loginBtn.disabled = true;
            log("ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’é–‹ãã¾ã™...");
            
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                .then(() => { return auth.signInWithPopup(provider); })
                .then((result) => {
                    log("ğŸ‰ ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ");
                    currentUser = result.user;
                    statusEl.innerText = currentUser.email;
                    statusEl.style.color = "#258FAF";
                    // ãã®ã¾ã¾å¾©æ—§ã¸
                    restoreData();
                })
                .catch((error) => {
                    log("âŒ ã‚¨ãƒ©ãƒ¼: " + error.message);
                    loginBtn.disabled = false;
                    alert("ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\nãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚");
                });
        }

        // ãƒ‡ãƒ¼ã‚¿å¾©å…ƒå‡¦ç†
        async function restoreData() {
            log("ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’æ¢ã—ã¾ã™...");
            
            try {
                const doc = await db_firebase.collection('users').doc(currentUser.uid).get();
                
                if (!doc.exists) {
                    log("âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                    alert("ã‚¯ãƒ©ã‚¦ãƒ‰ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\nPCã‹ã‚‰é€ä¿¡ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ");
                    loginBtn.disabled = false;
                    return;
                }

                const cloudWords = doc.data().words || [];
                log(`ğŸ“¦ ${cloudWords.length}èªã‚’ç™ºè¦‹ã€‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...`);

                // 1. IndexedDB æ›¸ãè¾¼ã¿
                await db.words.clear();
                await db.words.bulkAdd(cloudWords);
                log("âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¾©å…ƒå®Œäº†");

                // 2. LocalStorage æ›¸ãè¾¼ã¿
                localStorage.setItem('aitan_words', JSON.stringify(cloudWords));
                const uniqueFolders = new Set(['main', ...cloudWords.map(w => w.folder || 'main')]);
                localStorage.setItem('aitan_folders', JSON.stringify(Array.from(uniqueFolders)));
                log("âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¾©å…ƒå®Œäº†");

                // å®Œäº†çŠ¶æ…‹ã¸
                loginBtn.style.display = 'none';
                goAppBtn.style.display = 'flex';
                log("ğŸš€ æº–å‚™å®Œäº†ï¼ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¦ãã ã•ã„");
                
            } catch (e) {
                log("âŒ ã‚¨ãƒ©ãƒ¼: " + e.message);
                loginBtn.disabled = false;
            }
        }

        // ã‚¢ãƒ—ãƒªã¸ç§»å‹•
        function goToApp() {
            // åŒã˜ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦å†…ã§ç§»å‹•ã™ã‚‹ã“ã¨ã§ã€PWAã®çŠ¶æ…‹ã‚’å¼•ãç¶™ã
            window.location.href = "./wordrobe.html";
        }
    </script>
</body>
</html>
