<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Wordrobe Fixer</title>
    
    <!-- PWAè¨­å®š -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="WR Fixer">
    <link rel="apple-touch-icon" href="https://conizm3.github.io/wordrobe/images/wordrobe-icon.png">
    
    <!-- å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body { font-family: sans-serif; background-color: #F8FAFC; color: #333; touch-action: manipulation; }
        .neu-flat { background: #F8FAFC; box-shadow: 5px 5px 10px #E6EFF5, -5px -5px 10px #FFFFFF; border-radius: 20px; }
        .neu-btn { background: #F8FAFC; box-shadow: 3px 3px 6px #E6EFF5, -3px -3px 6px #FFFFFF; border-radius: 12px; transition: 0.1s; }
        .neu-btn:active { box-shadow: inset 2px 2px 4px #E6EFF5, inset -2px -2px 4px #FFFFFF; transform: scale(0.98); }
        .log-area { background: #1e293b; color: #4ade80; font-family: monospace; font-size: 10px; padding: 10px; border-radius: 8px; height: 120px; overflow-y: auto; text-align: left; }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center p-6">

    <div class="neu-flat p-6 w-full max-w-sm text-center relative">
        <div class="absolute top-0 left-0 w-full h-1 bg-[#258FAF] rounded-t-2xl"></div>
        
        <h1 class="text-xl font-bold text-[#258FAF] mb-2 flex items-center justify-center gap-2">
            <i class="fas fa-tools"></i> ä¿®å¾©ï¼†èµ·å‹•ãƒ„ãƒ¼ãƒ« V5
        </h1>
        <p class="text-xs text-gray-400 mb-6">
            é€šä¿¡ã‚¨ãƒ©ãƒ¼ã‚’ç›´ã—ã€ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¦<br>ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¾ã™ã€‚
        </p>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
        <div id="status" class="text-sm font-bold text-gray-600 mb-4 h-6">æœªãƒ­ã‚°ã‚¤ãƒ³</div>

        <!-- ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
        <div class="space-y-3">
            <button id="loginBtn" onclick="startLogin()" class="neu-btn w-full py-4 text-[#258FAF] font-bold flex items-center justify-center gap-2">
                <i class="fab fa-google"></i> ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦å¾©æ—§
            </button>

            <!-- å¾©æ—§å¾Œã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒœã‚¿ãƒ³ -->
            <button id="goAppBtn" onclick="goToApp()" class="w-full py-4 bg-[#258FAF] text-white rounded-xl font-bold shadow-lg hidden flex items-center justify-center gap-2 animate-pulse">
                <i class="fas fa-play"></i> ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã™ã‚‹
            </button>
        </div>

        <!-- ãƒ­ã‚°ã‚¨ãƒªã‚¢ -->
        <div class="mt-6">
            <div id="logs" class="log-area">ã‚·ã‚¹ãƒ†ãƒ å¾…æ©Ÿä¸­...</div>
        </div>
    </div>

    <script>
        const logEl = document.getElementById('logs');
        function log(msg) {
            logEl.innerHTML += `\n> ${msg}`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        // é‡è¦ï¼šãƒ›ãƒ¼ãƒ ç”»é¢ã‹ã‚‰é–‹ã„ã¦ã„ã‚‹å ´åˆã¯è­¦å‘Šã‚’å‡ºã™
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
        if (isStandalone) {
            alert("âš ï¸ é‡è¦ âš ï¸\nã“ã®ä¿®å¾©ãƒ„ãƒ¼ãƒ«ã¯ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã®ã‚¢ã‚¤ã‚³ãƒ³ã€ã‹ã‚‰ã¯æ­£ã—ãå‹•ãã¾ã›ã‚“ã€‚\n\nSafariãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‹ã„ã¦ã€ãã“ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚");
        }

        // èµ·å‹•æ™‚ã«ã‚¾ãƒ³ãƒ“SWã‚’å³æ­»ã•ã›ã€ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.getRegistrations()
                    .then(function(registrations) {
                        if (registrations.length > 0) {
                            log("âš ï¸ é‚ªé­”ãªService Workerã‚’ç™ºè¦‹");
                            let count = 0;
                            for(let registration of registrations) {
                                registration.unregister().then(() => {
                                    log("ğŸ”¥ å‰Šé™¤ã—ã¾ã—ãŸ: " + registration.scope);
                                    count++;
                                    if(count === registrations.length) {
                                        log("â™»ï¸ ã‚¯ãƒªãƒ¼ãƒ³ã«ã™ã‚‹ãŸã‚ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™...");
                                        setTimeout(() => window.location.reload(), 1000);
                                    }
                                });
                            }
                        } else {
                            log("âœ… é€šä¿¡ç’°å¢ƒã¯ã‚¯ãƒªãƒ¼ãƒ³ã§ã™");
                        }
                    })
                    .catch(function(error) {
                        console.warn("SW Check skipped", error);
                    });
            });
        }

        const firebaseConfig = {
            apiKey: "AIzaSyCqoqNq7N-x5Wr6TsJkyCU0J6o-Mj1Ir8g",
            authDomain: "conizm-01.firebaseapp.com",
            projectId: "conizm-01",
            storageBucket: "conizm-01.firebasestorage.app",
            messagingSenderId: "180210157068",
            appId: "1:180210157068:web:e03a373dd3f818cdee1029",
            measurementId: "G-YD40SF3F32"
        };
        
        try {
            firebase.initializeApp(firebaseConfig);
        } catch(e) {
            console.error(e);
        }
        
        const db_firebase = firebase.firestore();
        
        // ã€é‡è¦ã€‘ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼å¯¾ç­–ï¼šå¼·åˆ¶çš„ã«ãƒ­ãƒ³ã‚°ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’ä½¿ç”¨ã™ã‚‹
        try {
            db_firebase.settings({ experimentalForceLongPolling: true, merge: true });
            log("âœ… é€šä¿¡ãƒ¢ãƒ¼ãƒ‰: å¼·åˆ¶ãƒ­ãƒ³ã‚°ãƒãƒ¼ãƒªãƒ³ã‚°");
        } catch(e) {
            log("âš ï¸ è¨­å®šè­¦å‘Š: " + e.message);
        }

        const auth = firebase.auth();
        const db = new Dexie('WordloopDB');
        db.version(3).stores({ words: '++id, word, nextReview, interval, repetition, efactor, addedAt, folder', deleted_words: 'word' });

        const loginBtn = document.getElementById('loginBtn');
        const goAppBtn = document.getElementById('goAppBtn');
        const statusEl = document.getElementById('status');
        let currentUser = null;

        // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        function startLogin() {
            log("ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’é–‹ãã¾ã™...");
            
            const provider = new firebase.auth.GoogleAuthProvider();
            
            auth.signInWithPopup(provider)
                .then((result) => {
                    log("ğŸ‰ ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ");
                    currentUser = result.user;
                    statusEl.innerText = currentUser.email;
                    statusEl.style.color = "#258FAF";
                    
                    loginBtn.disabled = true;
                    loginBtn.innerText = "ãƒ‡ãƒ¼ã‚¿å¾©å…ƒä¸­...";
                    
                    // å°‘ã—å¾…ã£ã¦ã‹ã‚‰å¾©å…ƒé–‹å§‹ï¼ˆé€šä¿¡å®‰å®šã®ãŸã‚ï¼‰
                    setTimeout(restoreData, 500);
                })
                .catch((error) => {
                    log("âŒ ã‚¨ãƒ©ãƒ¼: " + error.message);
                    if (error.code === 'auth/popup-blocked' || error.message.includes('popup')) {
                        alert("âš ï¸ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚\n\niPhoneã®ã€Œè¨­å®š > Safari > ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚¯ã€ã‚’OFFã«ã—ã¦ã€ã“ã®ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚");
                    } else {
                        alert("ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: " + error.message);
                    }
                });
        }

        // ãƒ‡ãƒ¼ã‚¿å¾©å…ƒå‡¦ç†
        async function restoreData() {
            log("ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’æ¢ã—ã¾ã™...");
            
            // å¿µã®ãŸã‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒã‚§ãƒƒã‚¯
            if (!navigator.onLine) {
                log("âš ï¸ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æœªæ¥ç¶šã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™");
            }

            try {
                // 10ç§’ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®š
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error("ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: é€šä¿¡ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚Wi-Fiã‚’åˆ‡ã£ã¦4G/5Gã§è©¦ã—ã¦ãã ã•ã„ã€‚")), 10000)
                );
                
                const docPromise = db_firebase.collection('users').doc(currentUser.uid).get();

                const doc = await Promise.race([docPromise, timeoutPromise]);
                
                if (!doc.exists) {
                    log("âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                    alert("ã‚¯ãƒ©ã‚¦ãƒ‰ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\nPCã‹ã‚‰é€ä¿¡ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ");
                    loginBtn.disabled = false;
                    loginBtn.innerText = "å†è©¦è¡Œ";
                    return;
                }

                const cloudWords = doc.data().words || [];
                log(`ğŸ“¦ ${cloudWords.length}èªã‚’ç™ºè¦‹ã€‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...`);

                // 1. IndexedDB æ›¸ãè¾¼ã¿
                await db.words.clear();
                await db.words.bulkAdd(cloudWords);
                log("âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¾©å…ƒå®Œäº†");

                // 2. LocalStorage æ›¸ãè¾¼ã¿
                localStorage.setItem('aitan_words', JSON.stringify(cloudWords));
                const uniqueFolders = new Set(['main', ...cloudWords.map(w => w.folder || 'main')]);
                localStorage.setItem('aitan_folders', JSON.stringify(Array.from(uniqueFolders)));
                log("âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¾©å…ƒå®Œäº†");

                // å®Œäº†çŠ¶æ…‹ã¸
                loginBtn.style.display = 'none';
                goAppBtn.style.display = 'flex';
                log("ğŸš€ æº–å‚™å®Œäº†ï¼ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¦ãã ã•ã„");
                alert("å¤§æˆåŠŸã§ã™ï¼\nä¸‹ã®ã€Œã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
                
            } catch (e) {
                log("âŒ ã‚¨ãƒ©ãƒ¼: " + e.message);
                loginBtn.disabled = false;
                loginBtn.innerText = "å†è©¦è¡Œ";
            }
        }

        // ã‚¢ãƒ—ãƒªã¸ç§»å‹•
        function goToApp() {
            window.location.href = "./wordrobe.html";
        }
    </script>
</body>
</html>
