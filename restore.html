<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Wordrobe Fixer V6</title>
    
    <!-- PWAè¨­å®š -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="WR Fixer">
    <link rel="apple-touch-icon" href="https://conizm3.github.io/wordrobe/images/wordrobe-icon.png">
    
    <!-- å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body { font-family: sans-serif; background-color: #F8FAFC; color: #333; touch-action: manipulation; }
        .neu-flat { background: #F8FAFC; box-shadow: 5px 5px 10px #E6EFF5, -5px -5px 10px #FFFFFF; border-radius: 20px; }
        .neu-btn { background: #F8FAFC; box-shadow: 3px 3px 6px #E6EFF5, -3px -3px 6px #FFFFFF; border-radius: 12px; transition: 0.1s; }
        .neu-btn:active { box-shadow: inset 2px 2px 4px #E6EFF5, inset -2px -2px 4px #FFFFFF; transform: scale(0.98); }
        .log-area { background: #1e293b; color: #4ade80; font-family: monospace; font-size: 10px; padding: 10px; border-radius: 8px; height: 120px; overflow-y: auto; text-align: left; }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center p-6">

    <div class="neu-flat p-6 w-full max-w-sm text-center relative">
        <div class="absolute top-0 left-0 w-full h-1 bg-[#258FAF] rounded-t-2xl"></div>
        
        <h1 class="text-xl font-bold text-[#258FAF] mb-2 flex items-center justify-center gap-2">
            <i class="fas fa-tools"></i> ä¿®å¾©ï¼†èµ·å‹•ãƒ„ãƒ¼ãƒ« V6
        </h1>
        <p class="text-xs text-gray-400 mb-6">
            éå¸¸ç”¨ãƒ«ãƒ¼ãƒˆ(REST API)ã‚’ä½¿ç”¨ã—ã¦<br>ãƒ‡ãƒ¼ã‚¿ã‚’å¼·åˆ¶å–å¾—ã—ã¾ã™ã€‚
        </p>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
        <div id="status" class="text-sm font-bold text-gray-600 mb-4 h-6">æœªãƒ­ã‚°ã‚¤ãƒ³</div>

        <!-- ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
        <div class="space-y-3">
            <button id="loginBtn" onclick="startLogin()" class="neu-btn w-full py-4 text-[#258FAF] font-bold flex items-center justify-center gap-2">
                <i class="fab fa-google"></i> ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦å¾©æ—§
            </button>

            <!-- å¾©æ—§å¾Œã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒœã‚¿ãƒ³ -->
            <button id="goAppBtn" onclick="goToApp()" class="w-full py-4 bg-[#258FAF] text-white rounded-xl font-bold shadow-lg hidden flex items-center justify-center gap-2 animate-pulse">
                <i class="fas fa-play"></i> ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã™ã‚‹
            </button>
        </div>

        <!-- ãƒ­ã‚°ã‚¨ãƒªã‚¢ -->
        <div class="mt-6">
            <div id="logs" class="log-area">ã‚·ã‚¹ãƒ†ãƒ å¾…æ©Ÿä¸­...</div>
        </div>
    </div>

    <script>
        const logEl = document.getElementById('logs');
        function log(msg) {
            logEl.innerHTML += `\n> ${msg}`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        // SWå¼·åˆ¶å‰Šé™¤ (ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¿½åŠ ç‰ˆ)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.getRegistrations()
                    .then(function(registrations) {
                        if (registrations && registrations.length > 0) {
                            log("âš ï¸ å¤ã„è¨­å®šã‚’å‰Šé™¤ä¸­...");
                            for(let registration of registrations) {
                                registration.unregister();
                            }
                            log("âœ… é€šä¿¡ç’°å¢ƒã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
                        }
                    })
                    .catch(function(err) {
                        // ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã‚‚ç„¡è¦–ã—ã¦é€²ã‚ã‚‹
                        console.warn("SW cleanup skipped:", err);
                        log("â„¹ï¸ SWãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ");
                    });
            });
        }

        const firebaseConfig = {
            apiKey: "AIzaSyCqoqNq7N-x5Wr6TsJkyCU0J6o-Mj1Ir8g",
            authDomain: "conizm-01.firebaseapp.com",
            projectId: "conizm-01",
            storageBucket: "conizm-01.firebasestorage.app",
            messagingSenderId: "180210157068",
            appId: "1:180210157068:web:e03a373dd3f818cdee1029",
            measurementId: "G-YD40SF3F32"
        };
        
        try {
            firebase.initializeApp(firebaseConfig);
        } catch(e) { console.error(e); }
        
        const db_firebase = firebase.firestore();
        const auth = firebase.auth();
        const db = new Dexie('WordloopDB');
        db.version(3).stores({ words: '++id, word, nextReview, interval, repetition, efactor, addedAt, folder', deleted_words: 'word' });

        const loginBtn = document.getElementById('loginBtn');
        const goAppBtn = document.getElementById('goAppBtn');
        const statusEl = document.getElementById('status');
        let currentUser = null;

        function startLogin() {
            log("ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’é–‹ãã¾ã™...");
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    log("ğŸ‰ ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ");
                    currentUser = result.user;
                    statusEl.innerText = currentUser.email;
                    statusEl.style.color = "#258FAF";
                    loginBtn.disabled = true;
                    loginBtn.innerText = "ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...";
                    restoreData();
                })
                .catch((error) => {
                    log("âŒ ã‚¨ãƒ©ãƒ¼: " + error.message);
                    alert("ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚");
                });
        }

        // â–¼â–¼â–¼ Firestore REST API ãƒ‘ãƒ¼ã‚µãƒ¼ â–¼â–¼â–¼
        function parseFirestoreValue(val) {
            if (val.stringValue !== undefined) return val.stringValue;
            if (val.integerValue !== undefined) return parseInt(val.integerValue);
            if (val.doubleValue !== undefined) return parseFloat(val.doubleValue);
            if (val.booleanValue !== undefined) return val.booleanValue;
            if (val.mapValue !== undefined) {
                const obj = {};
                for (const k in val.mapValue.fields) {
                    obj[k] = parseFirestoreValue(val.mapValue.fields[k]);
                }
                return obj;
            }
            if (val.arrayValue !== undefined) {
                return (val.arrayValue.values || []).map(parseFirestoreValue);
            }
            return null;
        }
        // â–²â–²â–²â–²â–²â–²

        async function restoreData() {
            log("ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹...");
            let cloudWords = [];

            try {
                // 1. ã¾ãšé€šå¸¸SDKã§è©¦ã™
                const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), 3000));
                const docPromise = db_firebase.collection('users').doc(currentUser.uid).get();
                const doc = await Promise.race([docPromise, timeoutPromise]);
                
                if (doc.exists) {
                    cloudWords = doc.data().words || [];
                    log("âœ… SDKçµŒç”±ã§å–å¾—æˆåŠŸ");
                } else {
                    log("âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (SDK)");
                }
            } catch (e) {
                // 2. å¤±æ•—ã—ãŸã‚‰ REST API ã§è©¦ã™ï¼ˆã“ã“ãŒæ–°æ©Ÿèƒ½ï¼‰
                log("âš ï¸ SDKã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€‚éå¸¸ç”¨ãƒ«ãƒ¼ãƒˆ(REST)ã§è©¦ã¿ã¾ã™...");
                try {
                    const token = await currentUser.getIdToken();
                    const url = `https://firestore.googleapis.com/v1/projects/conizm-01/databases/(default)/documents/users/${currentUser.uid}`;
                    
                    const res = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (!res.ok) throw new Error("REST API Error: " + res.status);
                    
                    const json = await res.json();
                    if (json.fields && json.fields.words) {
                        cloudWords = parseFirestoreValue(json.fields.words);
                        log("âœ… éå¸¸ç”¨ãƒ«ãƒ¼ãƒˆã§å–å¾—æˆåŠŸï¼");
                    } else {
                        log("âš ï¸ REST: ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                    }
                } catch (restError) {
                    log("âŒ éå¸¸ç”¨ãƒ«ãƒ¼ãƒˆã‚‚å¤±æ•—: " + restError.message);
                    loginBtn.disabled = false;
                    loginBtn.innerText = "å†è©¦è¡Œ";
                    alert("ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šä¿¡ç’°å¢ƒã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                    return;
                }
            }

            if (cloudWords.length === 0) {
                log("âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒ0ä»¶ã§ã™");
                alert("ã‚¯ãƒ©ã‚¦ãƒ‰ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
                loginBtn.disabled = false;
                loginBtn.innerText = "å†è©¦è¡Œ";
                return;
            }

            log(`ğŸ“¦ ${cloudWords.length}èªã‚’ä¿å­˜ã—ã¾ã™...`);

            try {
                // DBæ›¸ãè¾¼ã¿
                await db.words.clear();
                await db.words.bulkAdd(cloudWords);
                
                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›¸ãè¾¼ã¿
                localStorage.setItem('aitan_words', JSON.stringify(cloudWords));
                const uniqueFolders = new Set(['main', ...cloudWords.map(w => w.folder || 'main')]);
                localStorage.setItem('aitan_folders', JSON.stringify(Array.from(uniqueFolders)));
                
                log("âœ… å…¨ã¦ã®å¾©å…ƒå®Œäº†");
                
                loginBtn.style.display = 'none';
                goAppBtn.style.display = 'flex';
                alert("å¾©å…ƒæˆåŠŸï¼\nã€Œã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");

            } catch (writeError) {
                log("âŒ æ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + writeError.message);
            }
        }

        function goToApp() {
            window.location.href = "./wordrobe.html";
        }
    </script>
</body>
</html>
