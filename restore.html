<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wordrobe Rescue V5</title>
    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #ffebeb; color: #333; text-align: center; }
        h1 { color: #d32f2f; font-size: 1.5rem; }
        .box { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin: 0 auto; max-width: 400px; }
        button { background: #d32f2f; color: white; border: none; padding: 15px; font-size: 1rem; font-weight: bold; border-radius: 10px; width: 100%; margin-top: 15px; cursor: pointer; }
        #logs { margin-top: 20px; background: #1e293b; color: #4ade80; padding: 10px; border-radius: 8px; font-family: monospace; font-size: 0.7rem; text-align: left; min-height: 150px; white-space: pre-wrap; }
    </style>
</head>
<body>

    <div class="box">
        <h1>ğŸš‘ æœ€çµ‚å…µå™¨ V5</h1>
        <p>é€šä¿¡ãƒ–ãƒ­ãƒƒã‚¯ã‚’ç ´å£Šã—ã¦<br>ãƒ‡ãƒ¼ã‚¿ã‚’å¾©æ—§ã—ã¾ã™ã€‚</p>
        
        <div id="status">æœªãƒ­ã‚°ã‚¤ãƒ³</div>
        
        <button id="actionBtn" onclick="startLogin()">Googleãƒ­ã‚°ã‚¤ãƒ³ (Popup)</button>
        
        <div id="logs">èµ·å‹•ä¸­...</div>
    </div>

    <script>
        const logEl = document.getElementById('logs');
        function log(msg) {
            logEl.innerHTML += `\n> ${msg}`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(msg);
        }

        // â–¼â–¼â–¼ ã“ã“ãŒæ–°æ©Ÿèƒ½ï¼šèµ·å‹•æ™‚ã«Service Workerã‚’æŠ¹æ®ºã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ â–¼â–¼â–¼
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(async function(registrations) {
                if (registrations.length > 0) {
                    log("âš ï¸ é‚ªé­”ãªService Workerã‚’ç™ºè¦‹");
                    for(let registration of registrations) {
                        await registration.unregister();
                        log("ğŸ”¥ å‰Šé™¤ã—ã¾ã—ãŸ: " + registration.scope);
                    }
                    log("â™»ï¸ ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦é©ç”¨ã—ã¾ã™...");
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    log("âœ… é€šä¿¡çµŒè·¯ã¯ã‚¯ãƒªãƒ¼ãƒ³ã§ã™");
                }
            });
        }
        // â–²â–²â–²â–²â–²â–²

        const firebaseConfig = {
            apiKey: "AIzaSyCqoqNq7N-x5Wr6TsJkyCU0J6o-Mj1Ir8g",
            authDomain: "conizm-01.firebaseapp.com",
            projectId: "conizm-01",
            storageBucket: "conizm-01.firebasestorage.app",
            messagingSenderId: "180210157068",
            appId: "1:180210157068:web:e03a373dd3f818cdee1029",
            measurementId: "G-YD40SF3F32"
        };
        
        try {
            firebase.initializeApp(firebaseConfig);
            log("Firebaseæº–å‚™OK");
        } catch(e) { log("Firebase Init Error"); }

        const db_firebase = firebase.firestore();
        const auth = firebase.auth();
        // â€»ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åˆ¶é™ã‚’å›é¿ã™ã‚‹ãŸã‚ã€è¨­å®šã‚’è¿½åŠ 
        db_firebase.settings({ experimentalForceLongPolling: true }); 

        const db = new Dexie('WordloopDB');
        db.version(3).stores({ words: '++id, word, nextReview, interval, repetition, efactor, addedAt, folder', deleted_words: 'word' });

        const btn = document.getElementById('actionBtn');
        const statusEl = document.getElementById('status');
        let currentUser = null;

        function startLogin() {
            log("ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‹ãã¾ã™...");
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.setPersistence(firebase.auth.Auth.Persistence.SESSION)
                .then(() => { return auth.signInWithPopup(provider); })
                .then((result) => {
                    log("ğŸ‰ ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ: " + result.user.email);
                    currentUser = result.user;
                    statusEl.innerText = "ãƒ­ã‚°ã‚¤ãƒ³ä¸­";
                    btn.innerText = "ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã‚€";
                    btn.onclick = restoreData;
                    btn.style.backgroundColor = "#258FAF";
                })
                .catch((error) => {
                    log("âŒ ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: " + error.message);
                    alert("ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚");
                });
        }

        async function restoreData() {
            if (!currentUser) return log("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“");
            log("ã‚¯ãƒ©ã‚¦ãƒ‰é€šä¿¡é–‹å§‹...");
            btn.disabled = true;

            // å¿µã®ãŸã‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’å†ç¢ºèª
            if (!navigator.onLine) {
                log("âš ï¸ ã‚¹ãƒãƒ›ãŒã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã®ã‚ˆã†ã§ã™");
                alert("ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«æ¥ç¶šã—ã¦ãã ã•ã„");
                btn.disabled = false;
                return;
            }

            try {
                // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãã§å–å¾—ã‚’è©¦ã¿ã‚‹
                const docPromise = db_firebase.collection('users').doc(currentUser.uid).get();
                const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: é€šä¿¡ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™")), 10000));

                const doc = await Promise.race([docPromise, timeoutPromise]);
                
                if (!doc.exists) {
                    log("âš ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ã«ãƒ‡ãƒ¼ã‚¿ç„¡ã—");
                    alert("ã‚¯ãƒ©ã‚¦ãƒ‰ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                    btn.disabled = false;
                    return;
                }

                const cloudWords = doc.data().words || [];
                log(`ğŸ“¦ ${cloudWords.length}ä»¶ã‚’å—ä¿¡æˆåŠŸï¼`);

                // 1. IndexedDB æ›¸ãè¾¼ã¿
                await db.words.clear();
                await db.words.bulkAdd(cloudWords);
                log("âœ… DBæ›¸ãè¾¼ã¿å®Œäº†");

                // 2. LocalStorage æ›¸ãè¾¼ã¿
                localStorage.setItem('aitan_words', JSON.stringify(cloudWords));
                const uniqueFolders = new Set(['main', ...cloudWords.map(w => w.folder || 'main')]);
                localStorage.setItem('aitan_folders', JSON.stringify(Array.from(uniqueFolders)));
                log("âœ… LocalStorageæ›¸ãè¾¼ã¿å®Œäº†");

                alert("å¤§æˆåŠŸã§ã™ï¼\nã“ã®ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã¦ã€wordrobe.html ã‚’é–‹ã„ã¦ãã ã•ã„ã€‚\nï¼ˆå¿…ãšãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ï¼‰");
                
            } catch (e) {
                log("ã‚¨ãƒ©ãƒ¼: " + e.message);
                if (e.message.includes("offline")) {
                    log("ãƒ’ãƒ³ãƒˆ: Wi-Fiã‚’åˆ‡ã£ã¦4G/5Gã§è©¦ã—ã¦ã¿ã¦ãã ã•ã„");
                }
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
